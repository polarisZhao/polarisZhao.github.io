

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="zhichao zhao">
  <meta name="keywords" content="">
  <title>MTCNN - 假欢畅 又何妨 无人共享</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/tomorrow.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.1.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>假欢畅，又何妨，无人共享</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2019-04-13 15:56" pubdate>
        April 13, 2019 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      24
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">MTCNN</h1>
            
            <div class="markdown-body" id="post-body">
              <p>论文阅读: MTCNN  Joint Face Detection and Alignment using Multi-task Cascaded Convolutional Networks</p>
<a id="more"></a>
<h4 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h4><p>​    相比于R-CNN系列通用检测方法，本文更加针对人脸检测这一专门的任务，速度和精度都有足够的提升。R-CNN，Fast R-CNN，FasterR-CNN这一系列的方法不是一篇博客能讲清楚的，有兴趣可以找相关论文阅读。类似于TCDCN，<strong>本文提出了一种 Multi-task的人脸检测框架，将人脸检测和人脸特征点检测同时进行。论文使用3个CNN级联的方式，和Viola-Jones类似，实现了coarse-to-fine的算法结构</strong>。</p>
<h4 id="2-框架"><a href="#2-框架" class="headerlink" title="2. 框架"></a>2. 框架</h4><p><strong>（1）.算法流程</strong></p>
<p><img src="/2019/04/13/MTCNN/1.jpg" srcset="/img/loading.gif" alt="algorithm flow"></p>
<p><strong>当给定一张照片的时候，将其缩放到不同尺度形成图像金字塔，以达到尺度不变。</strong></p>
<p><strong>Stage 1：使用P-Net是一个全卷积网络，用来生成候选窗和边框回归向量(bounding box regression vectors)。使用Bounding box regression的方法来校正这些候选窗，使用非极大值抑制（NMS）合并重叠的候选框。全卷积网络和Faster R-CNN中的RPN一脉相承。</strong></p>
<p><strong>Stage 2：使用N-Net改善候选窗。将通过P-Net的候选窗输入R-Net中，拒绝掉大部分false的窗口，继续使用Bounding box regression和NMS合并。</strong></p>
<p><strong>Stage 3：最后使用O-Net输出最终的人脸框和特征点位置。和第二步类似，但是不同的是生成5个特征点位置。</strong></p>
<p><strong>（2）CNN结构</strong></p>
<p>本文使用三个CNN，结构如图：</p>
<p><img src="/2019/04/13/MTCNN/2.png" srcset="/img/loading.gif" alt="MTCNN"></p>
<p><strong>（3）.训练</strong></p>
<p>这个算法需要实现三个任务的学习：人脸非人脸的分类，bounding box regression和人脸特征点定位。</p>
<p>(1)人脸检测</p>
<p>这就是一个分类任务，使用交叉熵损失函数即可：</p>
<script type="math/tex; mode=display">
L_i^{det} = -(y_i^{det}log(p_i)+(1-y_i^{det})(1-log(p_i)))</script><p>(2)Bounding box regression</p>
<p>这是一个回归问题，使用平方和损失函数：</p>
<script type="math/tex; mode=display">
L_i^{box} = || y_i^{box} - y_i^{box} ||_2^2</script><p>(3)人脸特征点定位</p>
<p>这也是一个回归问题，目标是5个特征点与标定好的数据的平方和损失：</p>
<script type="math/tex; mode=display">
L_i^{Landmark} = ||y_i^{landmark} - y_i^{landmark}||</script><p><strong>(4)多任务训练</strong></p>
<p>不是每个sample都要使用这三种损失函数的，比如对于背景只需要计算$L^{det}_i$，不需要计算别的损失，这样就需要引入一个指示值指示样本是否需要计算某一项损失。最终的训练目标函数是：</p>
<script type="math/tex; mode=display">
min\sum_{i=1}^{N} \sum_{j \in \{det,box,landmark\}} \alpha_j\beta_i^jL_i^j</script><p>N是训练样本的数量，$\alpha<em>j$表示任务的重要性。在 P-Net 和 R-Net 中，$\alpha</em>{det}=1, \alpha<em>{box}=0.5, \alpha</em>{landmark}=0.5$，在O-Net中，$\alpha<em>{det}=1, \alpha</em>{box}=0.5, \alpha_{landmark}=1$</p>
<p><strong>(5)online hard sample mining</strong></p>
<p>传统的难例处理方法是检测过一次以后，手动检测哪些困难的样本无法被分类，本文采用online hard sample mining的方法。具体就是在每个mini-batch中，取loss最大的70%进行反向传播，忽略那些简单的样本。</p>
<h4 id="3-实验"><a href="#3-实验" class="headerlink" title="3. 实验"></a>3. 实验</h4><p>本文主要使用三个数据集进行训练：FDDB，Wider Face，AFLW。</p>
<p>A、训练数据</p>
<p>本文将数据分成4种：</p>
<p>Negative：非人脸 </p>
<p>Positive：人脸 </p>
<p>Part faces：部分人脸 </p>
<p>Landmark face：标记好特征点的人脸</p>
<p>分别用于训练三种不同的任务。Negative和Positive用于人脸分类，positive和part faces用于bounding box regression，landmark face用于特征点定位。</p>
<p>B、效果</p>
<p>本文的人脸检测和人脸特征点定位的效果都非常好。关键是这个算法速度很快，在2.6GHZ的CPU上达到16fps，在Nvidia Titan达到99fps。</p>
<h4 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h4><p>本文使用一种级联的结构进行人脸检测和特征点检测，该方法速度快效果好，可以考虑在移动设备上使用。这种方法也是一种由粗到细的方法，和Viola-Jones的级联AdaBoost思路相似。</p>
<p>类似于Viola-Jones：1、如何选择待检测区域：图像金字塔+P-Net；2、如何提取目标特征：CNN；3、如何判断是不是指定目标：级联判断。</p>
<h4 id="5-训练流程"><a href="#5-训练流程" class="headerlink" title="5. 训练流程"></a>5. 训练流程</h4><p>第一阶段：首先对原图片构建一个金字塔，对不同尺寸的图片调整到12x12输入到PNet(Propossal)中，PNet会返回诸多的Bbox，利用nms选取合适的Bbox。</p>
<p>第二阶段，由PNet得出的候选框输送给RNet(Refine)， RNet会对相应的Bbox进行精细回归，并返回置信度。利用nms对精细回归后的Bbox进行nms选取， 并舍弃相应的置信度较低的人脸。</p>
<p>第三阶段和第二阶段相似，只不过最后会返回相应的Landmark坐标。</p>
<p>具体的训练过程如下所示：</p>
<p><img src="/2019/04/13/MTCNN/train_step.png" srcset="/img/loading.gif" alt></p>
<p><strong>具体的技术细节：</strong></p>
<p><strong>(1) 如何构造金字塔：</strong></p>
<p>如果输入图像为100×120, 假设输入图像中存在一个人脸，则其中人脸最小为20×20，最大为100×100——对应图像较短边长, 为了将人脸放缩到12×12，同时保证相邻层间缩放比率factor=0.709，则金子塔中图像尺寸依次为 60×72、52×61、36×43、26×31、18×22、13×16，其中60×72对应把20×20的人脸缩放到12×12，13×16对应把100×100的人脸缩放到12×12</p>
<pre><code class="hljs python"><span class="hljs-comment"># scales for scaling the image</span>
scales = [] 
m = min_detection_size/min_face_size
min_length *= m 
factor_count = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> min_length &gt; min_detection_size:  
    scales.append(m*factor**factor_count)
    min_length *= factor  
    factor_count += <span class="hljs-number">1</span></code></pre>
<p><strong>(2) 如何生成训练数据?</strong></p>
<p>PNet 网络：pos、part、neg 是随机裁剪得到的图像，landmark截取的是带有关键点的图像。将这些图像都resize成12x12 作为PNet的输入。</p>
<p>RNet网络：图片(金字塔之后)经过PNet 产生产生的大量人脸框，然后将其resize为 24x24大小作为Rnet 输入。</p>
<p>ONet网络： 图片(金字塔之后)经过PNet 和 RNet 产生的过滤后的人脸框，然后将其 resize 为 48x48大小作为ONet 的输入。</p>
<p>注意：</p>
<ul>
<li>pos[IoU&gt;0.65]、part[0.4&lt;=IoU&lt;0.65]、neg[IoU&lt;0.3] </li>
<li>BBox 和 Landmark 都是需要进行归一化的</li>
</ul>
<p><strong>(2)NMS的基本原理：</strong> </p>
<p>非极大值抑制（NMS）顾名思义就是抑制不是极大值的元素，搜索局部的极大值。</p>
<ul>
<li>将所有框的得分降序排列，选中最高分及其对应的框。</li>
<li>遍历其余的框，如果和当前最高分框的重叠面积(IOU)大于一定阈值，我们就将框删除。</li>
<li>从未处理的框中继续选一个得分最高的，重复上述过程。</li>
</ul>
<pre><code class="hljs python"><span class="hljs-comment"># nms python cpu 实现</span>
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">py_cpu_nms</span>(<span class="hljs-params">dets, thresh</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;Pure Python NMS baseline.&quot;&quot;&quot;</span>
    x1 = dets[:, <span class="hljs-number">0</span>]
    y1 = dets[:, <span class="hljs-number">1</span>]
    x2 = dets[:, <span class="hljs-number">2</span>]
    y2 = dets[:, <span class="hljs-number">3</span>]
    scores = dets[:, <span class="hljs-number">4</span>]

    areas = (x2 - x1 + <span class="hljs-number">1</span>) * (y2 - y1 + <span class="hljs-number">1</span>)
    order = scores.argsort()[::<span class="hljs-number">-1</span>]

    keep = []
    <span class="hljs-keyword">while</span> order.size &gt; <span class="hljs-number">0</span>:
        i = order[<span class="hljs-number">0</span>]
        keep.append(i)
        xx1 = np.maximum(x1[i], x1[order[<span class="hljs-number">1</span>:]])
        yy1 = np.maximum(y1[i], y1[order[<span class="hljs-number">1</span>:]])
        xx2 = np.minimum(x2[i], x2[order[<span class="hljs-number">1</span>:]])
        yy2 = np.minimum(y2[i], y2[order[<span class="hljs-number">1</span>:]])

        w = np.maximum(<span class="hljs-number">0.0</span>, xx2 - xx1 + <span class="hljs-number">1</span>)
        h = np.maximum(<span class="hljs-number">0.0</span>, yy2 - yy1 + <span class="hljs-number">1</span>)
        inter = w * h
        ovr = inter / (areas[i] + areas[order[<span class="hljs-number">1</span>:]] - inter)

        inds = np.where(ovr &lt;= thresh)[<span class="hljs-number">0</span>]
        order = order[inds + <span class="hljs-number">1</span>]

    <span class="hljs-keyword">return</span> keep</code></pre>
<p><strong>（3）三个任务的损失是什么？函数如何平衡？</strong></p>
<p>第一个任务是分类任务：其损失函数为交叉熵损失函数。第二个任务和第三个任务均是回归任务，其损失是平方均差损失函数。通过加权 $\alpha$ 来平衡三个任务的权重：在 P-Net 和 R-Net 中，$\alpha<em>{det}=1, \alpha</em>{box}=0.5, \alpha<em>{landmark}=0.5$，在O-Net中，$\alpha</em>{det}=1, \alpha<em>{box}=0.5, \alpha</em>{landmark}=1$</p>
<p><strong>（4）论文的主要创新点？ 尽量简单概括</strong></p>
<p>​    通过级联三个卷积神经网络来实现人脸的检测和Landmark定位。另外本文也提出了一种online hard sample mining方法，具体就是在每个mini-batch中，取loss最大的70%进行反向传播，忽略那些简单的样本。</p>
<p><strong>（5）有什么改进措施？</strong></p>
<ul>
<li>融入 anchor机制， 同时可以修改损失函数为 focal loss</li>
<li>加大数据增强方法</li>
<li>bn层、leakey relu/prelu</li>
<li>模仿shufflenet、mobilenet进行改进提高速度</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Face/">Face</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/face%E3%80%81MTCNN/">face、MTCNN</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/04/13/FaceBoxes/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">FaceBoxes</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/04/13/Classification-neural-network/">
                        <span class="hidden-mobile">Classification_neural_network</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "MTCNN&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.staticfile.org/mathjax/3.0.5/es5/tex-svg.js" ></script>

  
















</body>
</html>
