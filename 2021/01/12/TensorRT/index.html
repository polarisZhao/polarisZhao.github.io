

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="zhichao zhao">
  <meta name="keywords" content="">
  <title>TensorRT - å‡æ¬¢ç•… åˆä½•å¦¨ æ— äººå…±äº«</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/tomorrow.min.css" />
    
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.1.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>å‡æ¬¢ç•…ï¼Œåˆä½•å¦¨ï¼Œæ— äººå…±äº«</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-01-12 09:29" pubdate>
        January 12, 2021 am
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.8k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      57
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">TensorRT</h1>
            
            <div class="markdown-body" id="post-body">
              <h3 id="1-TensorRT-ç®€ä»‹"><a href="#1-TensorRT-ç®€ä»‹" class="headerlink" title="1. TensorRT ç®€ä»‹"></a>1. TensorRT ç®€ä»‹</h3><p>TensorRT æ˜¯ä¸€ä¸ªå‰å‘æ¨ç†æ¡†æ¶ã€‚åœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼ŒåŸºäºTensorRT çš„åº”ç”¨ç¨‹åºçš„æ‰§è¡Œé€Ÿåº¦å¯ä»¥æ¯” CPU å¹³å°é€Ÿåº¦å¿« 40 å€ã€‚</p>
<ul>
<li>ä¸åŒçš„ç¡¬ä»¶éœ€è¦åŒ¹é…ä¸åŒçš„ cudaåº“ï¼Œç„¶åè¿˜éœ€è¦è¿›è¡Œæµ‹è¯•ï¼Œ æ¯”å¦‚é€‰æ ¸ç­‰æ“ä½œ</li>
<li>TensorRT ä»¥  NVIDIA çš„å¹¶è¡Œç¼–ç¨‹æ¨¡å‹ CUDA ä¸ºåŸºç¡€æ„å»ºè€Œæˆã€‚</li>
<li>TensorRT é’ˆå¯¹å¤šç§æ·±åº¦å­¦ä¹ æ¨ç†åº”ç”¨çš„ç”Ÿäº§éƒ¨ç½²æä¾› INT8 å’Œ FP 16 ä¼˜åŒ–</li>
</ul>
<p>TensorRT æ¡†æ¶æ”¯æŒå¤§å¤šæ•°çš„ DeepLearning æ¡†æ¶</p>
<p><img src="/2021/01/12/TensorRT/1.png" srcset="/img/loading.gif" style="zoom:35%;"></p>
<p>TensorRT æ ¸å¿ƒä¼˜åŒ–æ–¹æ³•</p>
<p><img src="/2021/01/12/TensorRT/2.png" srcset="/img/loading.gif" style="zoom:50%;"></p>
<h3 id="2-TensorRT-OSS"><a href="#2-TensorRT-OSS" class="headerlink" title="2. TensorRT OSS"></a>2. TensorRT OSS</h3><h5 id="1-TensorRT-OSS"><a href="#1-TensorRT-OSS" class="headerlink" title="(1) TensorRT OSS"></a>(1) TensorRT OSS</h5><p>TensorRT åˆ†ä¸ºå¼€æºå’Œé—­æºä¸¤éƒ¨åˆ†</p>
<p>å¼€æºéƒ¨åˆ†ï¼š<a target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT">https://github.com/NVIDIA/TensorRT</a></p>
<p>â€‹        NVIDIA TensorRT çš„å¼€æºè½¯ä»¶(OSS) ç»„ä»¶ï¼šå…¶ä¸­åŒ…æ‹¬ TensorRT æ’ä»¶å’Œè§£æå™¨(caffe å’Œ ONNX) çš„èµ„æºï¼Œ ä»¥åŠæ¼”ç¤º TensorRT å¹³å°ç”¨æ³•å’ŒåŠŸèƒ½çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚ è¿™äº›å¼€æºè½¯ä»¶ç»„ä»¶æ˜¯ TensorRT General Availibility(GA) å‘è¡Œç‰ˆçš„å­é›†ï¼Œ å…·æœ‰ä¸€äº›æ‰©å±•å’Œé”™è¯¯ä¿®å¤ã€‚</p>
<p>é—­æºç‰ˆæœ¬ï¼š é‡åŒ–ã€æ¨ç†è®¡ç®—ã€kernel æŸ¥æ‰¾ç­‰</p>
<h5 id="2-å®‰è£…æµç¨‹"><a href="#2-å®‰è£…æµç¨‹" class="headerlink" title="(2) å®‰è£…æµç¨‹"></a>(2) å®‰è£…æµç¨‹</h5><p>git è·å–å®Œæˆçš„ OSS é¡¹ç›®åŒ…</p>
<pre><code class="hljs shell">git clone -b https://github/nvidia/TensorRT TensorRT
cd TensorRT
git submodule update --init --recursive # å®‰è£…ä¸€äº›å­æ¨¡å—: æ¯”å¦‚ cubã€protobufã€onnxã€pybind11 ç­‰
export TRT_SOURCE=&#x27;pwd&#x27;</code></pre>
<p>å®‰è£… GA åŒ…</p>
<pre><code class="hljs shell">cd ~/Downloads
tar -xvzf TensorRT-7.2.1.6.CentOS-7.6.x86_64-gnu.cuda-11.0.cudnn8.0.tar.gz
export TRT_RELEASE=`pwd`/TensorRT-7.2.1.6</code></pre>
<p>OSS é¡¹ç›®ç¼–è¯‘</p>
<pre><code class="hljs shell">cd $TRT_SOURCE
mkdir -p build &amp;&amp; cd build
cmake .. -DTRT_LIB_DIR=$TRT_RELEASE/lib -DTRT_OUT_DIR=`pwd`/out # ä¼šå°† OSS ç‰ˆæœ¬è¦†ç›–åŸæœ‰ç‰ˆæœ¬
<span class="hljs-meta">#</span><span class="bash"> è¾“å‡ºäºŒè¿›åˆ¶åº“ lib å’Œ å¯æ‰§è¡Œæ–‡ä»¶(ç¤ºä¾‹ä»£ç )</span>
make -j$(nproc)</code></pre>
<h5 id="3-TensorRT-OSS-ç›®å½•"><a href="#3-TensorRT-OSS-ç›®å½•" class="headerlink" title="(3) TensorRT OSS ç›®å½•"></a>(3) TensorRT OSS ç›®å½•</h5><ul>
<li>parser</li>
<li>plugin</li>
<li>examples</li>
</ul>
<h3 id="3-TensorRT-å¼€å‘"><a href="#3-TensorRT-å¼€å‘" class="headerlink" title="3. TensorRT å¼€å‘"></a>3. TensorRT å¼€å‘</h3><h5 id="ï¼ˆ1ï¼‰pytorch-gt-onnx"><a href="#ï¼ˆ1ï¼‰pytorch-gt-onnx" class="headerlink" title="ï¼ˆ1ï¼‰pytorch -&gt; onnx"></a>ï¼ˆ1ï¼‰pytorch -&gt; onnx</h5><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> torch.autograd <span class="hljs-keyword">import</span> Variable
<span class="hljs-keyword">import</span> torch.onnx <span class="hljs-keyword">as</span> torch_onnx
<span class="hljs-keyword">import</span> onnx

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    input_shape = (<span class="hljs-number">3</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>)
    model_onnx_path = <span class="hljs-string">&#x27;unet.onnx&#x27;</span>
    dummy_input = Variable(torch.randn(<span class="hljs-number">1</span>, *input_shape))
    model = torch.hub.load(<span class="hljs-string">&#x27;mateuszbuda/brain-segmentation-pytorch&#x27;</span>, <span class="hljs-string">&#x27;unet&#x27;</span>, in_channels=<span class="hljs-number">3</span>, out_channels=<span class="hljs-number">1</span>, init_features=<span class="hljs-number">32</span>, pretrained=<span class="hljs-literal">True</span>)
    
    model.train(<span class="hljs-literal">False</span>)
    inputs = [<span class="hljs-string">&quot;input.1&quot;</span>]
    outputs = [<span class="hljs-string">&quot;186&quot;</span>]
    dynamic_axes = &#123;<span class="hljs-string">&#x27;input.1&#x27;</span>:&#123;<span class="hljs-number">0</span>: <span class="hljs-string">&#x27;batch&#x27;</span>&#125;, <span class="hljs-string">&#x27;186&#x27;</span>:&#123;<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;batch&#x27;</span>&#125;&#125;
    out = torch.onnx.export(model, dummy_input, model_onnx_path, 
                            input_names=inputs, output_names=outputs, dynamic_axes=dynamic_axes)</code></pre>
<h5 id="ï¼ˆ2ï¼‰è®¡ç®—å›¾ä¼˜åŒ–ï¼šonnx-ä¼˜åŒ–"><a href="#ï¼ˆ2ï¼‰è®¡ç®—å›¾ä¼˜åŒ–ï¼šonnx-ä¼˜åŒ–" class="headerlink" title="ï¼ˆ2ï¼‰è®¡ç®—å›¾ä¼˜åŒ–ï¼šonnx ä¼˜åŒ–"></a>ï¼ˆ2ï¼‰è®¡ç®—å›¾ä¼˜åŒ–ï¼šonnx ä¼˜åŒ–</h5><p><strong>å¸¸è§çš„å¤„ç†ï¼š</strong></p>
<ul>
<li><p>reshape çš„æ—¶å€™çš„å¾ˆå¤šå†—ä½™ç®—å­çš„é—®é¢˜</p>
</li>
<li><p>è¾“å…¥çš„å½’ä¸€åŒ–ï¼šå»æ‰ï¼Œæ”¾åœ¨ä»£ç é€»è¾‘é‡Œé¢</p>
</li>
<li>conv_bn çš„åˆå¹¶</li>
<li>ä¸€äº›æ— æ³• boardcast çš„é—®é¢˜</li>
<li>æ–°å±‚çš„æ³¨å†Œ</li>
</ul>
<p><strong>ä¸¤ä¸ªå·¥å…·ï¼š</strong></p>
<ul>
<li><p>å¯è§†åŒ–å›¾:  Netron</p>
</li>
<li><p>onnx-simplify</p>
</li>
</ul>
<p><strong>onnx æ¨¡å‹å¿«é€ŸéªŒè¯ï¼š</strong></p>
<ul>
<li><p>TensorRT OSS å®Œæˆç¼–è¯‘ä¹‹åä¼šç”Ÿæˆ trtexec</p>
</li>
<li><p>é€šè¿‡ trtexec ç›´æ¥åŠ è½½ onnxï¼Œ éªŒè¯å¯¼å‡ºæ¨¡å‹æ˜¯å¦è¢« TensorRT æ”¯æŒ</p>
</li>
<li><p>æ ¹æ®æ”¯æŒæƒ…å†µï¼ŒæŒ‡å®šç®—å­å®ç°æ–¹æ¡ˆ</p>
<ul>
<li>ç›´æ¥åŸºäºç®—å­ op è¿›è¡Œå¼€å‘ï¼Œ æ¶‰åŠå¤šä¸ª kernel å¯åŠ¨ï¼Œæ€§èƒ½å¯èƒ½ç›¸å¯¹è¾ƒå·®</li>
<li>ä½¿ç”¨ plugin è¿›è¡Œå¼€å‘</li>
</ul>
</li>
</ul>
<h5 id="ï¼ˆ3ï¼‰-è‡ªå®šä¹‰ç»„ä»¶-TensorRT-Plugin"><a href="#ï¼ˆ3ï¼‰-è‡ªå®šä¹‰ç»„ä»¶-TensorRT-Plugin" class="headerlink" title="ï¼ˆ3ï¼‰ è‡ªå®šä¹‰ç»„ä»¶ TensorRT Plugin"></a>ï¼ˆ3ï¼‰ è‡ªå®šä¹‰ç»„ä»¶ TensorRT Plugin</h5><p>å®˜æ–¹æ–‡æ¡£ï¼š <a target="_blank" rel="noopener" href="https://docs.nvidia.com/deeplearning/tensorrt/developer-guide/index.html#extending">https://docs.nvidia.com/deeplearning/tensorrt/developer-guide/index.html#extending</a></p>
<p>TensorRT çš„ Plugin å¼€å‘è¯¦è§£<br>â‘  è§‚å¯Ÿç½‘ç»œç»“æ„ï¼Œ ç¡®è®¤ç®—å­çš„ç‰ˆæœ¬ã€åç§°ã€è¾“å…¥ã€è¾“å‡ºã€å‚æ•°åŠç›¸åº”æƒé‡<br>â‘¡ å¼€å‘ç®—å­çš„è§£ææ¨¡å— parser<br>â‘¢ ç»§æ‰¿ PluginV2Ext, å®Œæˆ kernel ä»¥åŠç›¸åº” API çš„å¼€å‘<br>â‘£ å®ç° Creator ç›¸å…³çš„æ“ä½œ</p>
<ul>
<li>è‡ªå®šä¹‰æ·»åŠ æ˜¯é€šè¿‡æ‰©å±• IPluginV2Ext å’Œ IPluginCreator å®ç°çš„</li>
<li>IPluginV2Ext: IPluginV2 çš„å‡çº§ç‰ˆæœ¬ï¼Œ å®ç°è‡ªå®šä¹‰æ’ä»¶çš„åŸºç±»ï¼Œ åŒ…å«ç‰ˆæœ¬åŒ–å’Œå…¶ä»–æ ¼å¼å’Œå•ç²¾åº¦çš„å¤„ç†</li>
<li>IPluginCreatorï¼š è‡ªå®šä¹‰å±‚çš„åˆ›å»ºç±»ï¼Œ å¯ä»¥é€šè¿‡å®ƒè·å–æ’ä»¶çš„åç§°ã€ç‰ˆæœ¬ä¿¡æ¯ã€å‚æ•°ç­‰ï¼Œ ä¹Ÿæä¾›ç½‘ç»œåˆ›å»ºé˜¶æ®µåˆ›å»ºæ’ä»¶çš„æ–¹æ³•ï¼Œ å¹¶åœ¨æ¨ç†é˜¶æ®µååºåˆ—åŒ–å®ƒã€‚</li>
</ul>
<h3 id="4-TensorRT-Plugin-å¼€å‘"><a href="#4-TensorRT-Plugin-å¼€å‘" class="headerlink" title="4. TensorRT Plugin å¼€å‘"></a>4. TensorRT Plugin å¼€å‘</h3><p>è‡ªå®šä¹‰ç»„ä»¶ TensorRT Plugin çš„æ•´ä½“æµç¨‹å¦‚ä¸‹æ‰€ç¤º:</p>
<ol>
<li>å®ç° Plugin ç±»å’Œ PluginCreator ç±»</li>
<li>åœ¨  InferPlugin.cpp ä¸­æ³¨å†Œæ–° creator</li>
<li>ä¿®æ”¹ CMakeLists.txt å¹¶ç¼–è¯‘ nvinfer_plugin åº“</li>
<li>åœ¨ onnx-tensorrt ä¸­æ³¨å†Œæ–°çš„ Pluginï¼šåœ¨ onnx ä¸­æ·»åŠ  parser</li>
<li>ç¼–è¯‘ nvonnxparse åº“</li>
<li>æ›¿æ¢ nvinfer_plugin å’Œ nvonnxparser åº“ï¼Œä½¿ç”¨ trtexec å°† onnx è½¬æ¢ä¸º tensorrt æ¨¡å‹</li>
</ol>
<p>ä¸‹é¢å¯¹æ¯ä¸€ä¸ªæ­¥éª¤è¿›è¡Œè¯¦ç»†çš„è®²è§£ï¼š</p>
<h5 id="Step1-å®ç°-Plugin-ç±»-å’Œ-PluginCreator-ç±»"><a href="#Step1-å®ç°-Plugin-ç±»-å’Œ-PluginCreator-ç±»" class="headerlink" title="Step1 å®ç° Plugin ç±» å’Œ PluginCreator ç±»"></a>Step1 å®ç° Plugin ç±» å’Œ PluginCreator ç±»</h5><p>è¯¥æ­¥éª¤å¯ä»¥å‚è€ƒä¸€ä¸‹ TensorRT å®˜æ–¹ plugin åº“ï¼š <a target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/tree/master/pluginã€‚å®˜æ–¹æä¾›äº†è¾ƒå¤šçš„">https://github.com/NVIDIA/TensorRT/tree/master/pluginã€‚å®˜æ–¹æä¾›äº†è¾ƒå¤šçš„</a> plugin æ’ä»¶ï¼Œ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶æºç ï¼Œç„¶åé€šè¿‡æ¨¡ä»¿æºç æ¥å­¦ä¹  plugin çš„ç¼–å†™ã€‚ è¿™é‡Œæˆ‘ä»¬ä»¥ nmsPlugin æ¥çœ‹ä¸€ä¸‹è‡ªå®šä¹‰çš„æ’ä»¶å¦‚ä½•ç¼–å†™:</p>
<pre><code class="hljs shell">.
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ README.md
â”œâ”€â”€ nmsPlugin.cpp  
â””â”€â”€ nmsPlugin.h

0 directories, 4 files</code></pre>
<p>è¿™é‡Œçš„ nmsPlugin ä¸»è¦å®ç° <code>DetectionOutput</code> å’Œ <code>NMSPluginCreator</code> ä¸¤ä¸ªç±»ï¼Œ å‰è€…ç”¨äºæ’ä»¶çš„å…·ä½“å®ç°ï¼Œåè€…ç”¨äºæ ¹æ®éœ€æ±‚åˆ›å»ºè¯¥æ’ä»¶ã€‚</p>
<pre><code class="hljs angelscript"><span class="hljs-keyword">class</span> <span class="hljs-symbol">DetectionOutput</span> : <span class="hljs-symbol">public</span> <span class="hljs-symbol">IPluginV2Ext</span>
<span class="hljs-symbol">class</span> <span class="hljs-symbol">NMSPluginCreator</span> : <span class="hljs-symbol">public</span> <span class="hljs-symbol">BaseCreator</span></code></pre>
<p><code>DetectionOutput</code> ç±»ç»§æ‰¿è‡ª <code>IPluginV2Ext</code>ã€‚åœ¨é˜…è¯»å…¶ä»–çš„æ’ä»¶æ³¨å†Œçš„æ—¶å€™ä¼šå‘ç°ç»§æ‰¿è‡ªå…¶ä»–ç±»çš„æƒ…å†µã€‚å…¶å®éšç€ TensorRT çš„ä¸æ–­å‘å±•ï¼Œæ’ä»¶æ¥å£ä¹Ÿåœ¨ä¸æ–­åœ°å˜åŒ–ï¼Œç”± v5 ç‰ˆæœ¬çš„<code>IPluginV2Ext</code>ï¼Œåˆ° v6 ç‰ˆæœ¬çš„ <code>IPluginV2IOExt</code> å’Œ <code>IPluginV2DynamicExt</code>ã€‚ å®˜æ–¹çš„å»ºè®®æ˜¯ç»§æ‰¿è‡ª  <code>IPluginV2IOExt</code> å’Œ  <code>IPluginV2DynamicExt</code>ã€‚ å…¶å®ä¸¤è€…åœ¨ç±»çš„ç¼–å†™ä¸Šç±»ä¼¼ï¼Œ åªæ˜¯å…¶ä¸­åè€…æ”¯æŒåŠ¨æ€å¤§å°ã€‚æˆ‘ä»¬çš„ç±»éœ€è¦ç»§æ‰¿è‡ªç‰¹å®šçš„ç±»ï¼Œå¹¶å®ç°å…¶ä¸­çš„è™šå‡½æ•°ã€‚</p>
<p>Plugin ç±»çš„ç›¸å…³å®ç°å‡½æ•°ï¼Œ ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘å°†å…¶åˆ†ä¸ºäº”ç±»ï¼Œ åˆ†åˆ«æ˜¯å‡†å¤‡å·¥ä½œæˆ–è€…ç»“æŸå·¥ä½œã€å…·ä½“å®ç°å’ŒåŠŸèƒ½å‡½æ•°ã€åºåˆ—åŒ–é—®é¢˜ã€æ’ä»¶çš„åŸºæœ¬è®¾ç½®å’Œè¿”å›å€¼ä¿¡æ¯ã€‚</p>
<p>ï¼ˆ1ï¼‰å‡†å¤‡å·¥ä½œæˆ–è€…ç»“æŸå·¥ä½œ</p>
<p><strong>æ„é€ å‡½æ•°:</strong> éœ€è¦æä¾›ä¸‰ç§åˆå§‹åŒ–æ–¹å¼ï¼Œ åˆ†åˆ«æ˜¯é€šè¿‡å‚æ•°çš„æ–¹å¼æ„é€ å‡½æ•°ï¼Œ é€šè¿‡ clone çš„æ–¹å¼æ„é€ å‡½æ•°ï¼Œ é€šè¿‡åºåˆ—åŒ–çš„æ–¹å¼æ„é€ å‡½æ•°   ğŸŒŸğŸŒŸ</p>
<pre><code class="hljs cpp"><span class="hljs-comment">// Parameterized constructor</span>
DetectionOutput::DetectionOutput(DetectionOutputParameters params) : param(params)&#123;&#125;

<span class="hljs-comment">// clone Constrcutor</span>
DetectionOutput::DetectionOutput(DetectionOutputParameters params, <span class="hljs-keyword">int</span> C1, <span class="hljs-keyword">int</span> C2, <span class="hljs-keyword">int</span> numPriors)
    : param(params), C1(C1), C2(C2), numPriors(numPriors)&#123;&#125;

<span class="hljs-comment">// constructor</span>
DetectionOutput::DetectionOutput(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span>* data, <span class="hljs-keyword">size_t</span> length)&#123;
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *d = <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>*&gt;(data), *a = d;
    param = read&lt;DetectionOutputParameters&gt;(d);
    <span class="hljs-comment">// Channel size of the locData tensor</span>
    <span class="hljs-comment">// numPriors * numLocClasses * 4</span>
    C1 = read&lt;<span class="hljs-keyword">int</span>&gt;(d);
    <span class="hljs-comment">// Channel size of the confData tensor</span>
    <span class="hljs-comment">// numPriors * param.numClasses</span>
    C2 = read&lt;<span class="hljs-keyword">int</span>&gt;(d);
    <span class="hljs-comment">// Number of bounding boxes per sample</span>
    numPriors = read&lt;<span class="hljs-keyword">int</span>&gt;(d);
    ASSERT(d == a + length);
&#125;</code></pre>
<ul>
<li>åˆå§‹åŒ–å‡½æ•° <code>initialize</code> å’Œ ç»“æŸå‡½æ•°  <code>terminate</code>   ç»“æŸå‡½æ•°ã€‚ ä¸€èˆ¬æ²¡æœ‰ä»€ä¹ˆå…·ä½“çš„å®ç°ï¼Œ è¿”å›çŠ¶æ€ï¼Œæˆ–è€…æ‰“å° log è€Œå·²ã€‚</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// åœ¨è¿™ä¸ªæ’ä»¶å‡†å¤‡å¼€å§‹ run ä¹‹å‰æ‰§è¡Œï¼Œ åšä¸€äº›åˆå§‹åŒ–å·¥ä½œ</span>
<span class="hljs-comment">// åˆå§‹åŒ–ä¸€äº›æå‰å¼€è¾Ÿç©ºé—´çš„å‚æ•°ï¼Œä¸€èˆ¬æ˜¯ cuda æ“ä½œéœ€è¦çš„å‚æ•°</span>
<span class="hljs-comment">// (ä¾‹å¦‚convæ“ä½œéœ€è¦æ‰§è¡Œå·ç§¯æ“ä½œï¼Œæˆ‘ä»¬å°±éœ€è¦æå‰å¼€è¾Ÿ weight å’Œ bias çš„æ˜¾å­˜)ï¼Œ</span>
<span class="hljs-comment">// å‡å¦‚æˆ‘ä»¬çš„ç®—å­éœ€è¦è¿™äº›å‚æ•°ï¼Œåˆ™åœ¨è¿™é‡Œéœ€è¦æå‰å¼€è¾Ÿæ˜¾å­˜</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">DetectionOutput::initialize</span><span class="hljs-params">()</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> STATUS_SUCCESS;
&#125;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DetectionOutput::terminate</span><span class="hljs-params">()</span> </span>&#123;
    gLogVerbose &lt;&lt; <span class="hljs-string">&quot;NMSPluginDynamic terminate\n&quot;</span>;
&#125;</code></pre>
<ul>
<li><code>clone</code>ï¼šå°†è¿™ä¸ª plugin å¯¹è±¡å…‹éš†ä¸€ä»½ TensorRT çš„ builderã€network æˆ–è€… engine   ğŸŒŸğŸŒŸ</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// Cloning the plugin</span>
<span class="hljs-function">IPluginV2Ext* <span class="hljs-title">DetectionOutput::clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-comment">// Create a new instance</span>
    IPluginV2Ext* plugin = <span class="hljs-keyword">new</span> DetectionOutput(param, C1, C2, numPriors);

    <span class="hljs-comment">// Set the namespace</span>
    plugin-&gt;setPluginNamespace(mPluginNamespace.c_str());
    <span class="hljs-keyword">return</span> plugin;
&#125;</code></pre>
<ul>
<li><code>destroy</code>: ä¸€äº›å–„åæ¸…ç†å·¥ä½œ </li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DetectionOutput::destroy</span><span class="hljs-params">()</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>;
&#125;</code></pre>
<p>(2) å…·ä½“å®ç°å’ŒåŠŸèƒ½å‡½æ•°</p>
<ul>
<li><code>enqueue</code>ï¼š æ’ä»¶ op çš„æ‰§è¡Œå‡½æ•° ã€‚ å…¶ä¸­ enqueue API å®ç°å°†å…·ä½“åŒ–çš„ kernel è°ƒç”¨è¿‡ç¨‹åŠ å…¥æ‰§è¡Œé˜Ÿåˆ—æ‰€åœ¨æµçš„åŠŸèƒ½ï¼Œå’Œå…·ä½“çš„ cuda kernel å®ç°ç›¸å…³è”ã€‚ ğŸŒŸğŸŒŸ</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// Plugin layer implementation</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">DetectionOutput::enqueue</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> batchSize, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span>* <span class="hljs-keyword">const</span>* inputs, <span class="hljs-keyword">void</span>** outputs, <span class="hljs-keyword">void</span>* workspace, cudaStream_t stream)</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-comment">// Input order &#123;loc, conf, prior&#125;</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span>* <span class="hljs-keyword">const</span> locData = inputs[param.inputOrder[<span class="hljs-number">0</span>]];
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span>* <span class="hljs-keyword">const</span> confData = inputs[param.inputOrder[<span class="hljs-number">1</span>]];
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span>* <span class="hljs-keyword">const</span> priorData = inputs[param.inputOrder[<span class="hljs-number">2</span>]];

    <span class="hljs-comment">// Output from plugin index 0: topDetections index 1: keepCount</span>
    <span class="hljs-keyword">void</span>* topDetections = outputs[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">void</span>* keepCount = outputs[<span class="hljs-number">1</span>];

    pluginStatus_t status = detectionInference(stream, batchSize, C1, C2, param.shareLocation,
        param.varianceEncodedInTarget, param.backgroundLabelId, numPriors, param.numClasses, param.topK, param.keepTopK,
        param.confidenceThreshold, param.nmsThreshold, param.codeType, DataType::kFLOAT, locData, priorData,
        DataType::kFLOAT, confData, keepCount, topDetections, workspace, param.isNormalized, param.confSigmoid);
    ASSERT(status == STATUS_SUCCESS);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;</code></pre>
<ul>
<li><code>attachToContext/detachFromContext</code>ï¼šå¦‚æœè¿™ä¸ª op ä½¿ç”¨åˆ°äº†ä¸€äº›å…¶ä»–ä¸œè¥¿ï¼Œ ä¾‹å¦‚ cublas handleï¼Œ å¯ä»¥ç›´æ¥å€ŸåŠ© TensorRT å†…éƒ¨æä¾›çš„ cublas handleã€‚</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// Attach the plugin object to an execution context and grant the plugin the access to some context resource.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DetectionOutput::attachToContext</span><span class="hljs-params">(cudnnContext* cudnnContext, cublasContext* cublasContext, IGpuAllocator* gpuAllocator)</span></span>&#123;&#125;

<span class="hljs-comment">// Detach the plugin object from its execution context.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DetectionOutput::detachFromContext</span><span class="hljs-params">()</span> </span>&#123;&#125;</code></pre>
<p>ï¼ˆ3ï¼‰åºåˆ—åŒ–é—®é¢˜</p>
<ul>
<li><code>getSerializationSize</code>ï¼šåºåˆ—åŒ–æ—¶éœ€è¦å†™å¤šå°‘å­—èŠ‚åˆ° buffer ä¸­   ğŸŒŸğŸŒŸ</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// Returns the size of serialized parameters</span>
<span class="hljs-function"><span class="hljs-keyword">size_t</span> <span class="hljs-title">DetectionOutput::getSerializationSize</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-comment">// DetectionOutputParameters, C1, C2, numPriors</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">sizeof</span>(DetectionOutputParameters) + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>) * <span class="hljs-number">3</span>;
&#125;</code></pre>
<ul>
<li><code>serialize</code>ï¼šæŠŠéœ€è¦ç”¨çš„æ•°æ®æŒ‰ç…§é¡ºåºåºåˆ—åŒ–åˆ° buffer é‡Œé¢    ğŸŒŸğŸŒŸ</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// Serialization of plugin parameters</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DetectionOutput::serialize</span><span class="hljs-params">(<span class="hljs-keyword">void</span>* buffer)</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">char</span> *d = <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">char</span>*&gt;(buffer), *a = d;
    write(d, param);
    write(d, C1);
    write(d, C2);
    write(d, numPriors);
    ASSERT(d == a + getSerializationSize());
&#125;</code></pre>
<p>ï¼ˆ4ï¼‰æ’ä»¶çš„åŸºæœ¬è®¾ç½®</p>
<p> <code>getPluginType</code> å’Œ  <code>getPluginVersion</code> æ’ä»¶çš„ç±»å‹æˆ–è€…ç‰ˆæœ¬</p>
<pre><code class="hljs cpp"> <span class="hljs-comment">// æ³¨æ„ä¸è¦é‡å¤å³å¯</span>
<span class="hljs-keyword">namespace</span> 
&#123;
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* NMS_PLUGIN_VERSION&#123;<span class="hljs-string">&quot;1&quot;</span>&#125;;
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* NMS_PLUGIN_NAME&#123;<span class="hljs-string">&quot;NMS_TRT&quot;</span>&#125;;
&#125;   <span class="hljs-comment">// namespace</span>

<span class="hljs-comment">// Get the plugin type</span>
<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">DetectionOutput::getPluginType</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> NMS_PLUGIN_NAME;
&#125;

<span class="hljs-comment">// Get the plugin version</span>
<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">DetectionOutput::getPluginVersion</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> NMS_PLUGIN_VERSION;
&#125;</code></pre>
<ul>
<li><code>set/getPluginNamespace</code>ï¼šè®¾ç½®/è·å–æ’ä»¶çš„å‘½åç©ºé—´ã€‚å¦‚æœä¸è®¾ç½®åˆ™é»˜è®¤ä¸º â€œâ€ï¼Œ éœ€è¦æ³¨æ„åŒä¸€ä¸ª namespace ä¸‹çš„ plugin å¦‚æœåå­—ç›¸åŒä¼šå†²çªã€‚</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DetectionOutput::setPluginNamespace</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* pluginNamespace)</span></span>
<span class="hljs-function"></span>&#123;
    mPluginNamespace = pluginNamespace;
&#125;

<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">DetectionOutput::getPluginNamespace</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> mPluginNamespace.c_str();
&#125;</code></pre>
<ul>
<li><code>supportsFormat</code>ï¼šåˆ¤æ–­æ ¼å¼/æ•°æ®ç±»å‹æ˜¯å¦åˆç†</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// Check if the DataType and Plugin format is supported</span>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">DetectionOutput::supportsFormat</span><span class="hljs-params">(DataType type, PluginFormat format)</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> (type == DataType::kFLOAT &amp;&amp; format == PluginFormat::kNCHW);
&#125;</code></pre>
<ul>
<li><code>getWorkspaceSize</code>ï¼šè¿”å›è¿™ä¸ªæ’ä»¶ op éœ€è¦ä¸­é—´æ˜¾å­˜å˜é‡çš„å®é™…æ•°æ®å¤§å°(bytesize)ï¼Œè¿™ä¸ªé€šè¿‡ TensorRT çš„æ¥å£å»è·å–ï¼Œæ˜¯æ¯”è¾ƒè§„èŒƒçš„æ–¹å¼ã€‚  ğŸŒŸğŸŒŸ</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// Returns the workspace size</span>
<span class="hljs-function"><span class="hljs-keyword">size_t</span> <span class="hljs-title">DetectionOutput::getWorkspaceSize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> maxBatchSize)</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> detectionInferenceWorkspaceSize(param.shareLocation, maxBatchSize, C1, C2, param.numClasses, numPriors, param.topK, DataType::kFLOAT, DataType::kFLOAT);
&#125;</code></pre>
<ul>
<li><code>configurePlugin</code>ï¼šé…ç½®è¿™ä¸ªæ’ä»¶ opï¼šè¾“å…¥å’Œè¾“å‡ºå’Œç›¸å…³å‚æ•°çš„éªŒè¯å’Œé…ç½®ã€‚ å®˜æ–¹è¿˜æåˆ°è¿™ä¸ªé…ç½®ä¿¡æ¯å¯ä»¥å‘ŠçŸ¥ TensorRT å»é€‰æ‹©åˆé€‚çš„ç®—æ³•å»è°ƒä¼˜è¿™ä¸ªæ¨¡å‹  ğŸŒŸğŸŒŸ</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// Configure the layer with input and output data types.</span>
<span class="hljs-comment">// inutDims: input Dimensions for the plugin layer</span>
<span class="hljs-comment">// nInputs : Number of inputs to the plugin layer</span>
<span class="hljs-comment">// outputDims: output Dimensions from the plugin layer</span>
<span class="hljs-comment">// nOutputs: number of outputs from the plugin layer</span>
<span class="hljs-comment">// type: DataType configuration for the plugin layer</span>
<span class="hljs-comment">// format: format NCHW, NHWC etc</span>
<span class="hljs-comment">// maxbatchSize: maximum batch size for the plugin layer</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DetectionOutput::configurePlugin</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Dims* inputDims, <span class="hljs-keyword">int</span> nbInputs, <span class="hljs-keyword">const</span> Dims* outputDims, <span class="hljs-keyword">int</span> nbOutputs, <span class="hljs-keyword">const</span> DataType* inputTypes, <span class="hljs-keyword">const</span> DataType* outputTypes, <span class="hljs-keyword">const</span> <span class="hljs-keyword">bool</span>* inputIsBroadcast, <span class="hljs-keyword">const</span> <span class="hljs-keyword">bool</span>* outputIsBroadcast, PluginFormat floatFormat, <span class="hljs-keyword">int</span> maxBatchSize)</span></span>
<span class="hljs-function"></span>&#123;
    ASSERT(nbInputs == <span class="hljs-number">3</span>);
    ASSERT(nbOutputs == <span class="hljs-number">2</span>);

    <span class="hljs-comment">// Verify all the input dimensions</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; nbInputs; i++)
    &#123;
        ASSERT(inputDims[i].nbDims == <span class="hljs-number">3</span>);
    &#125;

    <span class="hljs-comment">// Verify all the output dimensions</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; nbOutputs; i++)
    &#123;
        ASSERT(outputDims[i].nbDims == <span class="hljs-number">3</span>);
    &#125;

    <span class="hljs-comment">// Configure C1, C2 and numPriors</span>
    <span class="hljs-comment">// Input ordering  C1, C2, numPriors</span>
    C1 = inputDims[param.inputOrder[<span class="hljs-number">0</span>]].d[<span class="hljs-number">0</span>];
    C2 = inputDims[param.inputOrder[<span class="hljs-number">1</span>]].d[<span class="hljs-number">0</span>];

    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> nbBoxCoordinates = <span class="hljs-number">4</span>;
    numPriors = inputDims[param.inputOrder[<span class="hljs-number">2</span>]].d[<span class="hljs-number">1</span>] / nbBoxCoordinates;
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> numLocClasses = param.shareLocation ? <span class="hljs-number">1</span> : param.numClasses;

    <span class="hljs-comment">// Verify C1</span>
    ASSERT(numPriors * numLocClasses * nbBoxCoordinates == inputDims[param.inputOrder[<span class="hljs-number">0</span>]].d[<span class="hljs-number">0</span>]);

    <span class="hljs-comment">// Verify C2</span>
    ASSERT(numPriors * param.numClasses == inputDims[param.inputOrder[<span class="hljs-number">1</span>]].d[<span class="hljs-number">0</span>]);
&#125;</code></pre>
<p>ï¼ˆ5ï¼‰ è¿”å›å€¼ä¿¡æ¯</p>
<ul>
<li><code>getNbOutputs</code>ï¼š æ’ä»¶ op è¿”å›å¤šå°‘ä¸ª Tensorã€‚æ ¹æ®è¯¥ç½‘ç»œå±‚çš„å®é™…è¾“å‡ºï¼Œè¿”å›ä¸€ä¸ªæ•´æ•°å³å¯ã€‚</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">//  The nmsPlugin generates an output of shape [batchSize, 1, keepTopK, 7] which contains the same information // as the outputs nmsed box locations, nmsed box scores, and nmsed box class IDs from batchedNMSPlugin, and an // another output of shape [batchSize, 1, 1, 1] which contains the same information as the output nmsed box // count from batchedNMSPlugin.</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">DetectionOutput::getNbOutputs</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
&#125;</code></pre>
<ul>
<li><code>getOutputDataType</code>: è¿”å›ç»“æœçš„ç±»å‹ï¼Œ ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬æ’ä»¶ op è¿”å›ç±»å‹ä¸è¾“å…¥ç±»å‹ä¸€è‡´ã€‚</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// Return the DataType of the plugin output at the requested index.</span>
<span class="hljs-function">DataType <span class="hljs-title">DetectionOutput::getOutputDataType</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index, <span class="hljs-keyword">const</span> nvinfer1::DataType* inputTypes, <span class="hljs-keyword">int</span> nbInputs)</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-comment">// Two outputs</span>
    ASSERT(index == <span class="hljs-number">0</span> || index == <span class="hljs-number">1</span>); <span class="hljs-comment">// è¿™é‡Œæœ‰ä¸¤ä¸ª outputï¼Œ éœ€è¦é¦–å…ˆåˆ¤æ–­ index æ˜¯å¦åˆç†ï¼Œç„¶åè¿”å›ç±»å‹</span>
    <span class="hljs-keyword">return</span> DataType::kFLOAT;
&#125;</code></pre>
<ul>
<li><code>getOutputDimensions</code>ï¼š TensorRT æ”¯æŒ Dynamic Shape çš„æ—¶å€™ï¼Œ batch è¿™ä¸€ç»´åº¦å¿…é¡»æ˜¯ explicit çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œ TensorRT å¤„ç†çš„ç»´åº¦ä»ä»¥å¾€çš„ä¸‰ç»´  [3, -1, -1] å˜æˆäº† [1, 3, -1, -1]ã€‚æœ€æ–°çš„ onnx-tensort ä¹Ÿå¿…é¡»è®¾ç½® explicit çš„ bacthsizeï¼Œ è€Œä¸”è¿™ä¸ª bacth ç»´åº¦åœ¨ getOutputDimensions ä¸­æ˜¯å¯ä»¥è·å–çš„ã€‚</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// Returns output dimensions at given index</span>
<span class="hljs-function">Dims <span class="hljs-title">DetectionOutput::getOutputDimensions</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index, <span class="hljs-keyword">const</span> Dims* inputs, <span class="hljs-keyword">int</span> nbInputDims)</span></span>
<span class="hljs-function"></span>&#123;
    ASSERT(nbInputDims == <span class="hljs-number">3</span>);
    ASSERT(index == <span class="hljs-number">0</span> || index == <span class="hljs-number">1</span>); <span class="hljs-comment">// </span>
    <span class="hljs-comment">// index 0 : Dimensions 1x param.keepTopK x 7</span>
    <span class="hljs-comment">// index 1: Dimensions 1x1x1</span>
    <span class="hljs-keyword">if</span> (index == <span class="hljs-number">0</span>)
    &#123;
        <span class="hljs-keyword">return</span> DimsCHW(<span class="hljs-number">1</span>, param.keepTopK, <span class="hljs-number">7</span>);
    &#125;
    <span class="hljs-keyword">return</span> DimsCHW(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
&#125;</code></pre>
<ul>
<li><code>isOutputBroadcastAcrossBatch</code>/<code>canBroadcastInputAcrossBatch</code>: output æ˜¯å¦è¿›è¡Œ boardcast ä»¥åŠèƒ½å¦è¿›è¡Œ boardcast</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-comment">// Return true if output tensor is broadcast across a batch.</span>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">DetectionOutput::isOutputBroadcastAcrossBatch</span><span class="hljs-params">(<span class="hljs-keyword">int</span> outputIndex, <span class="hljs-keyword">const</span> <span class="hljs-keyword">bool</span>* inputIsBroadcasted, <span class="hljs-keyword">int</span> nbInputs)</span> <span class="hljs-keyword">const</span></span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
&#125;

<span class="hljs-comment">// Return true if plugin can use input that is broadcast across batch without replication.</span>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">DetectionOutput::canBroadcastInputAcrossBatch</span><span class="hljs-params">(<span class="hljs-keyword">int</span> inputIndex)</span> <span class="hljs-keyword">const</span></span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
&#125;</code></pre>
<p>PluginCreator ç±»çš„ç›¸å…³å®ç°å‡½æ•°ï¼Œç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ã€‚</p>
<p>ï¼ˆ1ï¼‰æ„é€ å‡½æ•°</p>
<pre><code class="hljs cpp"><span class="hljs-comment">// Plugin creator constructor</span>
NMSPluginCreator::NMSPluginCreator()
&#123;
    <span class="hljs-comment">// NMS Plugin field meta data &#123;name,  data, type, length&#125;</span>
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;shareLocation&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kINT32, <span class="hljs-number">1</span>));
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;varianceEncodedInTarget&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kINT32, <span class="hljs-number">1</span>));
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;backgroundLabelId&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kINT32, <span class="hljs-number">1</span>));
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;numClasses&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kINT32, <span class="hljs-number">1</span>));
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;topK&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kINT32, <span class="hljs-number">1</span>));
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;keepTopK&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kINT32, <span class="hljs-number">1</span>));
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;confidenceThreshold&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kFLOAT32, <span class="hljs-number">1</span>));
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;nmsThreshold&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kFLOAT32, <span class="hljs-number">1</span>));
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;inputOrder&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kINT32, <span class="hljs-number">3</span>));
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;confSigmoid&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kINT32, <span class="hljs-number">1</span>));
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;isNormalized&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kINT32, <span class="hljs-number">1</span>));
    mPluginAttributes.emplace_back(PluginField(<span class="hljs-string">&quot;codeType&quot;</span>, <span class="hljs-literal">nullptr</span>, PluginFieldType::kINT32, <span class="hljs-number">1</span>));

    mFC.nbFields = mPluginAttributes.size();
    mFC.fields = mPluginAttributes.data();
&#125;</code></pre>
<p>ï¼ˆ2ï¼‰createPluginï¼šè¿™ä¸ªæˆå‘˜å‡½æ•°ä½œç”¨æ˜¯é€šè¿‡ PluginFieldCollection å»åˆ›å»º pluginï¼Œ å°† op éœ€è¦çš„æƒé‡å’Œå‚æ•°é€ä¸€å–å‡ºæ¥ï¼Œ ç„¶åè°ƒç”¨ä¸Šæ–‡æåˆ°çš„æ„é€ å‡½æ•°ã€‚</p>
<pre><code class="hljs cpp"><span class="hljs-comment">// Creates the NMS plugin</span>
<span class="hljs-function">IPluginV2Ext* <span class="hljs-title">NMSPluginCreator::createPlugin</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* name, <span class="hljs-keyword">const</span> PluginFieldCollection* fc)</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">const</span> PluginField* fields = fc-&gt;fields;
    <span class="hljs-comment">// Default init values for TF SSD network</span>
    params.codeType = CodeTypeSSD::TF_CENTER;
    params.inputOrder[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
    params.inputOrder[<span class="hljs-number">1</span>] = <span class="hljs-number">2</span>;
    params.inputOrder[<span class="hljs-number">2</span>] = <span class="hljs-number">1</span>;

    <span class="hljs-comment">// Read configurations from  each fields</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; fc-&gt;nbFields; ++i)
    &#123;
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* attrName = fields[i].name;
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(attrName, <span class="hljs-string">&quot;shareLocation&quot;</span>))
        &#123;
            ASSERT(fields[i].type == PluginFieldType::kINT32);
            params.shareLocation = <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">int</span>&gt;(*(<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span>*&gt;(fields[i].data)));
        &#125;
        <span class="hljs-comment">// ....</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(attrName, <span class="hljs-string">&quot;codeType&quot;</span>))
        &#123;
            ASSERT(fields[i].type == PluginFieldType::kINT32);
            params.codeType = <span class="hljs-keyword">static_cast</span>&lt;CodeTypeSSD&gt;(*(<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span>*&gt;(fields[i].data)));
        &#125;
    &#125;

    DetectionOutput* obj = <span class="hljs-keyword">new</span> DetectionOutput(params);
    obj-&gt;setPluginNamespace(mNamespace.c_str());
    <span class="hljs-keyword">return</span> obj;
&#125;</code></pre>
<p>ï¼ˆ3ï¼‰deserializePluginï¼š è¿™ä¸ªå‡½æ•°ä¼šè¢« onnx-tensorrt çš„ä¸€ä¸ªå«åš TRT_PluginV2 çš„è½¬æ¢ op è°ƒç”¨ï¼Œ è¿™ä¸ª op ä¼šè¯»å– onnx æ¨¡å‹çš„ data æ•°æ®å°†å…¶ååºåˆ—åŒ–åˆ° network ä¸­ã€‚</p>
<pre><code class="hljs cpp"><span class="hljs-function">IPluginV2Ext* <span class="hljs-title">NMSPluginCreator::deserializePlugin</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* name, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span>* serialData, <span class="hljs-keyword">size_t</span> serialLength)</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-comment">// This object will be deleted when the network is destroyed, which will</span>
    <span class="hljs-comment">// call NMS::destroy()</span>
    DetectionOutput* obj = <span class="hljs-keyword">new</span> DetectionOutput(serialData, serialLength);
    obj-&gt;setPluginNamespace(mNamespace.c_str());
    <span class="hljs-keyword">return</span> obj;
&#125;</code></pre>
<p>ï¼ˆ4ï¼‰ ä¸€äº›æ’ä»¶ç›¸å…³ä¿¡æ¯é…ç½®çš„å‡½æ•°</p>
<pre><code class="hljs cpp"><span class="hljs-comment">// Returns the plugin name</span>
<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">NMSPluginCreator::getPluginName</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> NMS_PLUGIN_NAME;
&#125;

<span class="hljs-comment">// Returns the plugin version</span>
<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">NMSPluginCreator::getPluginVersion</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> NMS_PLUGIN_VERSION;
&#125;

<span class="hljs-comment">// Returns the plugin field names</span>
<span class="hljs-function"><span class="hljs-keyword">const</span> PluginFieldCollection* <span class="hljs-title">NMSPluginCreator::getFieldNames</span><span class="hljs-params">()</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> &amp;mFC;
&#125;</code></pre>
<p>(5)  è·å– PluginFieldCollectionã€‚PluginFieldCollection çš„ä¸»è¦ä½œç”¨æ˜¯ä¼ é€’è¿™ä¸ªæ’ä»¶ op æ‰€éœ€è¦çš„æƒé‡å’Œå‚æ•°ï¼Œ åœ¨å®é™…çš„ engine æ¨ç†è¿‡ç¨‹ä¸­å¹¶ä¸ä½¿ç”¨ï¼Œ è€Œåœ¨ parse ä¸­ä¼šç”¨åˆ°ï¼ˆæ¯”å¦‚ caffe2trtã€onnx2trtï¼‰ã€‚</p>
<pre><code class="hljs cpp"><span class="hljs-comment">// Returns the plugin field names</span>
<span class="hljs-function"><span class="hljs-keyword">const</span> PluginFieldCollection* <span class="hljs-title">NMSPluginCreator::getFieldNames</span><span class="hljs-params">()</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">return</span> &amp;mFC;
&#125;</code></pre>
<h5 id="Step2ï¼š-åœ¨-InferPlugin-cpp-ä¸­æ³¨å†Œæ–°-creator"><a href="#Step2ï¼š-åœ¨-InferPlugin-cpp-ä¸­æ³¨å†Œæ–°-creator" class="headerlink" title="Step2ï¼š åœ¨  InferPlugin.cpp ä¸­æ³¨å†Œæ–° creator"></a>Step2ï¼š åœ¨  InferPlugin.cpp ä¸­æ³¨å†Œæ–° creator</h5><p>æ³¨å†Œè¿‡ç¨‹ï¼Œ ç»´æŠ¤mapç»“æ„ï¼Œå®ç°å­—ç¬¦ä¸²åˆ° creator çš„æ˜ å°„ã€‚</p>
<p>æ–‡ä»¶è·¯å¾„ï¼š<code>TensorRT/plugin/inferplugin.cpp</code></p>
<p>å°†è‡ªå®šä¹‰çš„ plugin åˆ›å»ºå™¨è¿›è¡Œåˆå§‹åŒ–ã€‚ ç³»ç»Ÿæœ€ç»ˆé€šè¿‡ creator æ˜ å°„å…³ç³»æ¥å®ç° plugin çš„åˆ›å»ºå’Œè°ƒç”¨</p>
<pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;nmsPlugin.h&quot;</span></span>

<span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span>
&#123;
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">initLibNvInferPlugins</span><span class="hljs-params">(<span class="hljs-keyword">void</span>* logger, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* libNamespace)</span></span>
<span class="hljs-function">    </span>&#123;
        initializePlugin&lt;nvinfer1::plugin::NMSPluginCreator&gt;(logger, libNamespace);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    &#125;
&#125; <span class="hljs-comment">// extern &quot;C&quot;</span></code></pre>
<h5 id="Step3-ä¿®æ”¹-CMakeLists-txt-å¹¶ç¼–è¯‘-nvinfer-plugin-åº“"><a href="#Step3-ä¿®æ”¹-CMakeLists-txt-å¹¶ç¼–è¯‘-nvinfer-plugin-åº“" class="headerlink" title="Step3: ä¿®æ”¹ CMakeLists.txt å¹¶ç¼–è¯‘ nvinfer_plugin åº“"></a>Step3: ä¿®æ”¹ CMakeLists.txt å¹¶ç¼–è¯‘ nvinfer_plugin åº“</h5><p>æ–‡ä»¶è·¯å¾„ï¼š<code>TensorRT/plugin/CMakeLists.txt</code></p>
<pre><code class="hljs cpp"><span class="hljs-comment">// å°† plugin æ·»åŠ  plugin list</span>
<span class="hljs-built_in">set</span>(PLUGIN_LISTS
    nmsPlugin
    )</code></pre>
<h5 id="setp-4-åœ¨-onnx-tensorrt-ä¸­æ³¨å†Œæ–°çš„-Plugin"><a href="#setp-4-åœ¨-onnx-tensorrt-ä¸­æ³¨å†Œæ–°çš„-Plugin" class="headerlink" title="setp 4: åœ¨ onnx-tensorrt ä¸­æ³¨å†Œæ–°çš„ Plugin"></a>setp 4: åœ¨ onnx-tensorrt ä¸­æ³¨å†Œæ–°çš„ Plugin</h5><p>æ–‡ä»¶è·¯å¾„ï¼š <code>TensorRT/parser/onnx/builtin_op_importers.cpp</code>ã€‚ æ·»åŠ æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="hljs cpp">DEFINE_BUILTIN_OP_IMPORTER(BatchNormalization)  <span class="hljs-comment">// OP å¯¼å…¥, å‚æ•°éƒ¨åˆ†ä¸º OP åç§°ï¼Œ éœ€è¦ä¸ onnx ä¸€è‡´</span>
&#123;
    <span class="hljs-comment">// Scale, bias, mean, and variance must be initializers</span>
    <span class="hljs-comment">// è§£æè¾“å…¥ä¿¡æ¯</span>
    <span class="hljs-keyword">auto</span> scale_weights = inputs.at(<span class="hljs-number">1</span>).weights();
    <span class="hljs-keyword">auto</span> bias_weights = inputs.at(<span class="hljs-number">2</span>).weights();
    <span class="hljs-keyword">auto</span> mean_weights = inputs.at(<span class="hljs-number">3</span>).weights();
    <span class="hljs-keyword">auto</span> variance_weights = inputs.at(<span class="hljs-number">4</span>).weights();

    <span class="hljs-comment">// ...</span>

    <span class="hljs-comment">// è§£æå±æ€§ä¿¡æ¯</span>
    <span class="hljs-function">OnnxAttrs <span class="hljs-title">attrs</span><span class="hljs-params">(node)</span></span>;
    <span class="hljs-keyword">float</span> eps = attrs.get&lt;<span class="hljs-keyword">float</span>&gt;(<span class="hljs-string">&quot;epsilon&quot;</span>, <span class="hljs-number">1e-5</span>f);

    nvinfer1::Dims dims = tensor_ptr-&gt;getDimensions();

    <span class="hljs-keyword">bool</span> need_to_expand_dims = (dims.nbDims == <span class="hljs-number">3</span>);

&#125;</code></pre>
<h5 id="step-5-Plugin-ç¼–è¯‘æ”¯æŒ"><a href="#step-5-Plugin-ç¼–è¯‘æ”¯æŒ" class="headerlink" title="step 5. Plugin ç¼–è¯‘æ”¯æŒ"></a>step 5. Plugin ç¼–è¯‘æ”¯æŒ</h5><p>ç¡®ä¿ TensorRT/Plugin/CMakeLists  ä¿è¯æ–°å¢åŠ çš„ Plugin èƒ½å¤Ÿè¢«æ­£å¸¸ç¼–è¯‘é€šè¿‡ã€‚</p>
<h5 id="step-6-ç¼–è¯‘-nvonnxparse-åº“"><a href="#step-6-ç¼–è¯‘-nvonnxparse-åº“" class="headerlink" title="step 6. ç¼–è¯‘ nvonnxparse åº“"></a>step 6. ç¼–è¯‘ nvonnxparse åº“</h5><h5 id="step-7-æ›¿æ¢-nvinfer-plugin-å’Œ-nvonnxparser-åº“ï¼Œä½¿ç”¨-trtexec-å°†-onnx-è½¬æ¢ä¸º-tensorrt-æ¨¡å‹"><a href="#step-7-æ›¿æ¢-nvinfer-plugin-å’Œ-nvonnxparser-åº“ï¼Œä½¿ç”¨-trtexec-å°†-onnx-è½¬æ¢ä¸º-tensorrt-æ¨¡å‹" class="headerlink" title="step 7. æ›¿æ¢ nvinfer_plugin å’Œ nvonnxparser åº“ï¼Œä½¿ç”¨ trtexec å°† onnx è½¬æ¢ä¸º tensorrt æ¨¡å‹"></a>step 7. æ›¿æ¢ nvinfer_plugin å’Œ nvonnxparser åº“ï¼Œä½¿ç”¨ trtexec å°† onnx è½¬æ¢ä¸º tensorrt æ¨¡å‹</h5><p>è¡¥å……ä¸€ä¸ªå­¦ä¹ å·¥å…·ï¼šTensorRT å·¥å…· kaldi-onnx   <a target="_blank" rel="noopener" href="https://github/com/XiaoMi/kaldi-onnx">https://github/com/XiaoMi/kaldi-onnx</a></p>
<p>ç”¨äºå°† kaldi è¯­éŸ³è¯†åˆ«å·¥å…·åŒ…ç¥ç»ç½‘ç»œæ¨¡å‹ç§»æ¤åˆ°onnxæ¨¡å‹è¿›è¡Œæ¨ç†çš„å·¥å…·ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ MACE åŠ å¿«å…·æœ‰é«˜åº¦ä¼˜åŒ–çš„ neon å†…æ ¸çš„ androidã€iosï¼Œ linux æˆ– windows è®¾å¤‡çš„æ¨æ–­ï¼Œè¯¥å·¥å…·æ”¯æŒè½¬æ¢ Nnet2 å’Œ Nnet3 æ¨¡å‹ã€‚</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/01/13/knowledge-distillation/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">knowledge-distillation</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/01/10/CPP-review/">
                        <span class="hidden-mobile">CPP_review</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "TensorRT&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.staticfile.org/mathjax/3.0.5/es5/tex-svg.js" ></script>

  
















</body>
</html>
